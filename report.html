<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Report Adverse Event - KME Commerce</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .file-list { list-style: none; padding: 0; margin: 1em 0; }
    .file-list li { display: flex; align-items: center; margin-bottom: 4px; }
    .file-list span { flex: 1; font-size: 0.99em; }
    .file-remove { color: #d43076; cursor: pointer; margin-left: 10px; border: none; background: none; font-size: 1.15em;}
    .file-remove:hover { color: #ff3340;}
    .dropzone {
      border: 2px dashed #1a8cff;
      background: #f6fbff;
      border-radius: 10px;
      padding: 0.8em 0.8em 0.6em 0.8em;
      text-align: center;
      margin-bottom: 0.8em;
      transition: background 0.15s;
      cursor: pointer;
    }
    .dropzone.dragover {
      background: #e6f2ff;
      border-color: #3596fa;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="navbar container">
      <a href="index.html" class="logo">KME Commerce</a>
      <button class="nav-toggle" aria-label="toggle navigation">
        <span class="hamburger"></span>
      </button>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="report.html" class="active">Report Event</a></li>
      </ul>
    </nav>
  </header>
  <main class="main-center container main-flex">
    <section class="report">
      <h2>Report an Adverse Event</h2>
      <p>
        Fill out your information and attach any files (optional). <br>
        You can drag & drop files or click to select multiple.<br>
        <span style="font-size:0.95em;color:#888;">Each submission creates a new folder for privacy.</span>
      </p>
      <form id="uploadForm" class="report-form" autocomplete="off">
        <label for="name">Your Name</label>
        <input type="text" id="name" required autocomplete="off"/>

        <label for="email">Your Email</label>
        <input type="email" id="email" required autocomplete="off"/>

        <label for="dropzone">Attachments (optional)</label>
        <div id="dropzone" class="dropzone">Drag & drop files here, or click to select</div>
        <input type="file" id="attachments" multiple style="display:none;"/>
        <ul id="fileList" class="file-list"></ul>

        <button type="submit" class="btn">Submit Report</button>
        <div id="msg"></div>
      </form>
    </section>
    <aside class="side-download">
      <div class="download-card">
        <h3>Download Form</h3>
        <a href="static/FDA_form.pdf" download class="download-btn" target="_blank">
          <span>Download</span>
        </a>
        <p style="font-size:0.97em;color:#555;margin-top:1.1em;">
          Fill This Report Out and Submit it below
        </p>
      </div>
    </aside>
  </main>
  <footer class="site-footer">
    <div class="container">
      <p>&copy; 2025 KME Commerce. All rights reserved.</p>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // --- Supabase setup ---
    const SUPABASE_URL = 'https://vbvkawjxysiwjtyumsvh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZidmthd2p4eXNpd2p0eXVtc3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjYzNzksImV4cCI6MjA2OTUwMjM3OX0.gqv9qb5GhH--ODIl-qjfRNpmLtuaSW3HXrdGHWnYwkg';
    const BUCKET = 'report-adverse-events';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Token generator ---
    function randomToken(length = 12) {
      const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
      let token = "";
      for (let i = 0; i < length; i++) {
        token += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return token;
    }

    // --- File drag and drop / picker logic ---
    let selectedFiles = [];
    const dropzone = document.getElementById("dropzone");
    const attachments = document.getElementById("attachments");
    const fileList = document.getElementById("fileList");

    // Open file dialog on dropzone click
    dropzone.onclick = () => attachments.click();

    // Drag events
    dropzone.ondragover = e => { e.preventDefault(); dropzone.classList.add("dragover"); };
    dropzone.ondragleave = () => dropzone.classList.remove("dragover");
    dropzone.ondrop = e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      addFiles(e.dataTransfer.files);
    };
    // On file input change
    attachments.onchange = () => addFiles(attachments.files);

    function addFiles(fileListObj) {
      for (let file of fileListObj) {
        // Prevent duplicate file names in current list
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified)) {
          selectedFiles.push(file);
        }
      }
      renderFileList();
      attachments.value = "";
    }
    function renderFileList() {
      fileList.innerHTML = "";
      selectedFiles.forEach((file, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${file.name}</span>
          <button class="file-remove" title="Remove file" onclick="removeFile(${idx});return false;">&times;</button>`;
        fileList.appendChild(li);
      });
    }
    // Remove file by index
    window.removeFile = idx => {
      selectedFiles.splice(idx, 1);
      renderFileList();
    };

    // --- Form Submission ---
    const form = document.getElementById("uploadForm");
    const msg = document.getElementById("msg");
    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = "";
      msg.className = "";

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!name || !email) {
        msg.textContent = "Please fill all fields.";
        msg.className = "error";
        return;
      }
      // --- Generate unique folder with random token ---
      const baseFolder = `${name.replace(/[^\w\s-]/g, '').replace(/\s+/g, '_')}-${email.replace(/[^\w@.-]/g, '')}`;
      const token = randomToken(12);
      const uniqueFolder = `${baseFolder}-${token}`;

      // --- Upload all files ---
      let uploadErrors = [];
      if (selectedFiles.length > 0) {
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const filePath = `${uniqueFolder}/${Date.now()}_${file.name}`;
          let { error: uploadError } = await client.storage
            .from(BUCKET)
            .upload(filePath, file);
          if (uploadError) {
            uploadErrors.push(file.name);
          }
        }
      }
      // --- Save a submission info file (txt) for tracking ---
      const infoTxt = `Name: ${name}\nEmail: ${email}\nTime: ${new Date().toLocaleString()}\nFiles: ${selectedFiles.map(f => f.name).join(", ")}`;
      await client.storage
        .from(BUCKET)
        .upload(`${uniqueFolder}/report.txt`, new Blob([infoTxt], {type:"text/plain"}));

      // --- Show message ---
      if (uploadErrors.length === 0) {
        msg.textContent = "Thank you! Your report has been submitted.";
        msg.className = "success";
      } else {
        msg.textContent = "Some files failed to upload: " + uploadErrors.join(", ");
        msg.className = "error";
      }
      form.reset();
      selectedFiles = [];
      renderFileList();
    };

    // Nav toggle for mobile
    const toggle = document.querySelector('.nav-toggle');
    const navLinks = document.querySelector('.nav-links');
    toggle.addEventListener('click', () => navLinks.classList.toggle('nav-open'));
  </script>
</body>
</html>
